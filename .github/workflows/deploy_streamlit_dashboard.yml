name: Build and deploy Streamlit dashboard to Azure Web App

on:
  push:
    branches: [ main ]
    paths:
      - 'analytics/**'
      - 'config/**'
      - 'Dockerfile.streamlit'
      - 'requirements.txt'
      - 'deploy-streamlit.sh'
      - '.github/workflows/deploy_streamlit_dashboard.yml'
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  RESOURCE_GROUP: trakt
  APP_NAME: trakt-dashboard
  IMAGE_NAME: trakt-streamlit

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_B782B4EF4C084DB68754745782B83A82 }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_EB5C7CA419CB478A891B392422373A3D }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_E4CB93E6899E4A55B8EA48212ABC8295 }}

      - name: Resolve ACR target
        shell: bash
        run: |
          set -euo pipefail

          # Optional override via repo/organization variable.
          ACR_NAME_INPUT="${{ vars.ACR_NAME }}"

          if [[ -n "${ACR_NAME_INPUT}" ]]; then
            if az acr show --name "${ACR_NAME_INPUT}" >/dev/null 2>&1; then
              ACR_NAME="${ACR_NAME_INPUT}"
            else
              echo "ERROR: vars.ACR_NAME='${ACR_NAME_INPUT}' does not exist or is not accessible in this subscription."
              exit 1
            fi
          else
            # Auto-discover from existing Web App container image.
            CURRENT_LINUX_FX="$(az webapp config show --name "${APP_NAME}" --resource-group "${RESOURCE_GROUP}" --query linuxFxVersion -o tsv || true)"
            # expected format: DOCKER|<registry>.azurecr.io/<image>:<tag>
            REGISTRY_HOST="$(echo "${CURRENT_LINUX_FX}" | sed -E 's#^DOCKER\|([^/]+)/.*#\1#')"

            if [[ -z "${REGISTRY_HOST}" || "${REGISTRY_HOST}" == "${CURRENT_LINUX_FX}" ]]; then
              echo "ERROR: Unable to auto-discover ACR from ${APP_NAME} linuxFxVersion='${CURRENT_LINUX_FX}'."
              echo "Set repository variable ACR_NAME to your registry name (e.g. myregistry)."
              exit 1
            fi

            ACR_NAME="${REGISTRY_HOST%%.*}"
            if ! az acr show --name "${ACR_NAME}" >/dev/null 2>&1; then
              echo "ERROR: Auto-discovered ACR '${ACR_NAME}' from '${REGISTRY_HOST}', but az acr show failed."
              echo "Set repository variable ACR_NAME explicitly."
              exit 1
            fi
          fi

          ACR_LOGIN_SERVER="$(az acr show --name "${ACR_NAME}" --query loginServer -o tsv)"
          echo "Using ACR_NAME=${ACR_NAME}"
          echo "ACR_NAME=${ACR_NAME}" >> "$GITHUB_ENV"
          echo "ACR_LOGIN_SERVER=${ACR_LOGIN_SERVER}" >> "$GITHUB_ENV"

      - name: Build and push immutable image to ACR
        shell: bash
        run: |
          set -euo pipefail
          IMAGE_TAG="${ACR_NAME}.azurecr.io/${IMAGE_NAME}:${GITHUB_SHA}"
          echo "IMAGE_TAG=${IMAGE_TAG}" >> "$GITHUB_ENV"

          az acr build \
            --registry "${ACR_NAME}" \
            --image "${IMAGE_NAME}:${GITHUB_SHA}" \
            --file Dockerfile.streamlit \
            .

      - name: Update Web App container to SHA tag
        shell: bash
        run: |
          set -euo pipefail

          az webapp config container set \
            --name "${APP_NAME}" \
            --resource-group "${RESOURCE_GROUP}" \
            --container-image-name "${IMAGE_TAG}" \
            --container-registry-url "https://${ACR_LOGIN_SERVER}"

      - name: Set build metadata app settings
        shell: bash
        run: |
          set -euo pipefail
          az webapp config appsettings set \
            --name "${APP_NAME}" \
            --resource-group "${RESOURCE_GROUP}" \
            --settings TRAKT_DASHBOARD_BUILD_SHA="${GITHUB_SHA}" >/dev/null

      - name: Restart Web App
        shell: bash
        run: |
          set -euo pipefail
          az webapp restart --name "${APP_NAME}" --resource-group "${RESOURCE_GROUP}"

      - name: Verify deployed image
        shell: bash
        run: |
          set -euo pipefail
          EXPECTED="DOCKER|${IMAGE_TAG}"
          ACTUAL="$(az webapp config show --name "${APP_NAME}" --resource-group "${RESOURCE_GROUP}" --query linuxFxVersion -o tsv)"

          echo "Expected linuxFxVersion: ${EXPECTED}"
          echo "Actual linuxFxVersion  : ${ACTUAL}"

          test "${ACTUAL}" = "${EXPECTED}"
